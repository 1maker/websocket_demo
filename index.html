<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>WebSocket</title>
	<style>
	
		canvas {
			
			outline: 2px dashed #b6e7ff; /* Pale blue.*/
		}
	
	</style>
</head>
<body>
	<h2>WebSocket Test</h2>
	<div id="output"></div>
	<canvas id="my_canvas" width="720" height="560"></canvas>
	<script>
	'use strict';
  
	let output;
	let websocket;
	let canvas = document.getElementById("my_canvas");
	let ctx = canvas.getContext("2d");
	
	function init() {
	
		output = document.getElementById("output");
		websocket = new WebSocket('ws://localhost:9000/');
		websocket.onopen = function(evt) { onOpen(evt) };
		websocket.onclose = function(evt) { onClose(evt) };
		websocket.onmessage = function(evt) { onMessage(evt) };
		websocket.onerror = function(evt) { onError(evt) };
	}

	function onOpen(evt) {
	
		writeToScreen("CONNECTED: "+websocket.readyState);
	}
	
	function onClose(evt) {
	
		writeToScreen("DISCONNECTED: "+websocket.readyState);
	}
	
	function onMessage(evt) {
	
		//writeToScreen('<span style="color: blue;">RESPONSE: ' + evt.data+" "+websocket.readyState+'</span>');
		
		let data = JSON.parse(evt.data);
		
		//console.log(data);
		
		if (Array.isArray(data)){
		
			data.map((item) => {
			
				const {x, y, color} = item;
		
				draw_ball(x - canvas.offsetLeft, y - canvas.offsetTop, color);
				
			});
			
		} else {
		
			const {x, y, color} = data;
		
			draw_ball(x - canvas.offsetLeft, y - canvas.offsetTop, color);
		}
		
		//websocket.close();
	}
	
	function onError(evt) {
	
		writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data+" "+websocket.readyState);
	}
	
	function do_send(coordinates) {
	
		//writeToScreen("SENT: " + coordinates+" "+websocket.readyState);
		websocket.send(coordinates);
	}

	function writeToScreen(message) {
	
		let pre = document.createElement("p");
		pre.style.wordWrap = "break-word";
		pre.innerHTML = message;
		output.appendChild(pre);
	}

	function mouse_down_handler(e) {
	
		if (e.which === 1){
		
			if (websocket.readyState === 1){
		
				do_send(JSON.stringify({x:e.clientX, y:e.clientY}));
			}
		
			canvas.addEventListener("mousemove", mouse_move_handler);
		}
	}

	function mouse_up_handler(e) {
	
		if (e.which === 1){
	
			canvas.removeEventListener('mousemove', mouse_move_handler);
		}
	}
		
	function mouse_move_handler(e) {
		
		if (websocket.readyState === 1) {
		
			do_send(JSON.stringify({x:e.clientX, y:e.clientY}));
		}
		
		//console.log('x clientX = ', e.clientX);
		//console.log('y clientY = ', e.clientY);
	}
	
	function draw_ball(x, y, color) {
	
		ctx.beginPath();
		ctx.arc(x, y, 3, 0, Math.PI*2);
		ctx.fillStyle = color;
		ctx.fill();
		ctx.closePath();
	}
	
	window.addEventListener("load", init, false);
	window.addEventListener("mousedown", mouse_down_handler);
	window.addEventListener("mouseup", mouse_up_handler);
		
	</script>
</body>
</html>